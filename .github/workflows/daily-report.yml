name: Daily Finance Report

on:
  schedule:
    - cron: '0 23 * * *'  # UTC 23:00 = KST 08:00
  workflow_dispatch:       # ìˆ˜ë™ ì‹¤í–‰

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 10    # ìµœëŒ€ 10ë¶„ ë‚´ ì™„ë£Œ ì•ˆ ë˜ë©´ ê°•ì œ ì¢…ë£Œ

    steps:
      # â”€â”€ 1. Secret ë“±ë¡ ì—¬ë¶€ ì‚¬ì „ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_KEY }}" ]; then
            echo "âŒ SUPABASE_KEY secretì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "   GitHub â†’ Settings â†’ Secrets â†’ SUPABASE_KEY ë¥¼ ë“±ë¡í•˜ì„¸ìš”."
            exit 1
          fi
          echo "âœ… Secret í™•ì¸ ì™„ë£Œ"

      # â”€â”€ 2. Edge Function í˜¸ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Trigger Supabase Edge Function
        id: trigger
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            --max-time 300 \
            -X POST \
            'https://xqfvkhlfvctxokciuogd.supabase.co/functions/v1/daily-report' \
            -H 'Authorization: Bearer ${{ secrets.SUPABASE_KEY }}' \
            -H 'Content-Type: application/json' \
            -d '{}')

          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | head -n -1)

          echo "HTTP Status : $http_code"
          echo "Response    : $body"

          # GitHub Actions Summaryì— ê²°ê³¼ ê¸°ë¡
          echo "## ğŸ“Š Daily Finance Report ìˆ˜ì§‘ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ì‹œê° (UTC)**: $(date -u '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **HTTP ìƒíƒœ**: $http_code" >> $GITHUB_STEP_SUMMARY

          if [ "$http_code" -eq 200 ]; then
            fetched=$(echo "$body" | grep -o '"fetched":[0-9]*' | grep -o '[0-9]*')
            failed=$(echo "$body"  | grep -o '"failed":[0-9]*'  | grep -o '[0-9]*')
            signal=$(echo "$body"  | grep -o '"signal":"[^"]*"' | cut -d'"' -f4)
            echo "- **ìˆ˜ì§‘ ì„±ê³µ**: ${fetched:-?}ì¢…ëª©" >> $GITHUB_STEP_SUMMARY
            echo "- **ìˆ˜ì§‘ ì‹¤íŒ¨**: ${failed:-?}ì¢…ëª©"  >> $GITHUB_STEP_SUMMARY
            echo "- **ì‹œì¥ ì‹œê·¸ë„**: ${signal:-?}"     >> $GITHUB_STEP_SUMMARY
            echo "âœ… ìˆ˜ì§‘ ì„±ê³µ (${fetched:-?}ì¢…ëª©)"
          else
            echo "- **ì˜¤ë¥˜ ë‚´ìš©**: \`$body\`" >> $GITHUB_STEP_SUMMARY
            echo "âŒ ìˆ˜ì§‘ ì‹¤íŒ¨ (HTTP $http_code)"
            echo "Response body: $body"
            exit 1
          fi

      # â”€â”€ 3. ì‹¤íŒ¨ ì‹œ Slack ì•Œë¦¼ (ì„ íƒ â€” SLACK_WEBHOOK_URL secret í•„ìš”) â”€â”€
      # - name: Notify failure on Slack
      #   if: failure()
      #   run: |
      #     curl -s -X POST '${{ secrets.SLACK_WEBHOOK_URL }}' \
      #       -H 'Content-Type: application/json' \
      #       -d '{"text":"âŒ Daily Finance Report ìˆ˜ì§‘ ì‹¤íŒ¨! GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."}'
