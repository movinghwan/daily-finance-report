<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í¬íŠ¸í´ë¦¬ì˜¤ ë°ì¼ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* [ìŠ¤íƒ€ì¼ ì‹œíŠ¸ëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ë¯€ë¡œ ê°€ë…ì„±ì„ ìœ„í•´ ìƒëµí•˜ì§€ë§Œ, ì‹¤ì œ íŒŒì¼ì—ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì„¸ìš”] */
  :root {
    --bg: #0f1117; --card: #1a1d2e; --card-hover: #222640;
    --border: #2a2d3e; --text: #e4e6f0; --text-dim: #8b8fa3;
    --accent: #6366f1; --green: #22c55e; --red: #ef4444;
    --orange: #f59e0b; --blue: #3b82f6; --purple: #a855f7; --cyan: #06b6d4;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--bg); color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6; padding: 20px; max-width: 1400px; margin: 0 auto;
  }
  /* ... (ì¤‘ëµ: ì—…ë¡œë“œí•´ì£¼ì‹  ì›ë³¸ index.htmlì˜ ëª¨ë“  CSS ìŠ¤íƒ€ì¼ì„ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë„£ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤) ... */
  .header { display: flex; justify-content: space-between; align-items: flex-start; padding: 24px 0; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
  .header h1 { font-size: 24px; font-weight: 700; }
  .header .date { color: var(--text-dim); font-size: 14px; margin-top: 4px; }
  .disclaimer { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #fca5a5; padding: 8px 16px; border-radius: 8px; font-size: 12px; max-width: 360px; text-align: right; }
  .date-nav { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
  .date-nav button { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
  .date-nav button:hover { border-color: var(--accent); background: var(--card-hover); }
  .date-nav button.active { border-color: var(--accent); background: rgba(99,102,241,0.15); }
  .date-nav input[type="date"] { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 8px; font-size: 14px; }
  .refresh-btn { background: linear-gradient(135deg, var(--accent), var(--purple)); border: none; color: white; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: opacity 0.2s; }
  .refresh-btn:hover { opacity: 0.85; }
  .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .summary-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
  .summary-card .label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
  .summary-card .value { font-size: 28px; font-weight: 700; margin-top: 4px; }
  .summary-card .sub { font-size: 13px; margin-top: 4px; }
  .section { margin-bottom: 32px; }
  .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
  .section-header h2 { font-size: 18px; font-weight: 600; }
  .badge { font-size: 11px; padding: 3px 10px; border-radius: 20px; font-weight: 500; }
  .badge-us { background: rgba(59,130,246,0.15); color: var(--blue); }
  .badge-kr { background: rgba(239,68,68,0.15); color: #f87171; }
  .badge-sector { background: rgba(168,85,247,0.15); color: var(--purple); }
  .sector-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px; }
  .sector-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center; transition: border-color 0.2s; }
  .sector-card .icon { font-size: 24px; margin-bottom: 8px; }
  .sector-card .name { font-size: 13px; font-weight: 600; }
  .sector-card .perf { font-size: 18px; font-weight: 700; margin-top: 4px; }
  .sector-card .detail { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
  .stock-table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .stock-table thead th { background: rgba(99,102,241,0.08); padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; border-bottom: 1px solid var(--border); }
  .stock-table tbody td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
  .ticker { font-weight: 700; color: var(--accent); font-size: 15px; }
  .company-name { color: var(--text-dim); font-size: 12px; }
  .price { font-weight: 600; font-size: 15px; font-variant-numeric: tabular-nums; }
  .change-pos { color: var(--green); font-weight: 600; }
  .change-neg { color: var(--red); font-weight: 600; }
  .signal { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
  .signal-positive { background: rgba(34,197,94,0.15); color: var(--green); }
  .signal-hold { background: rgba(245,158,11,0.15); color: var(--orange); }
  .signal-watch { background: rgba(99,102,241,0.15); color: var(--accent); }
  .signal-caution { background: rgba(239,68,68,0.15); color: var(--red); }
  .news-item { font-size: 12px; color: var(--text-dim); line-height: 1.5; padding: 2px 0; }
  .news-item::before { content: "â€¢"; color: var(--accent); margin-right: 6px; }
  .insight-box { background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(168,85,247,0.08)); border: 1px solid rgba(99,102,241,0.2); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
  .insight-box h3 { color: var(--accent); font-size: 16px; margin-bottom: 12px; }
  .insight-box ul { list-style: none; padding: 0; }
  .insight-box li { padding: 6px 0; font-size: 14px; border-bottom: 1px solid rgba(99,102,241,0.1); }
  .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: var(--text-dim); font-size: 16px; }
  .loading .spinner { width: 24px; height: 24px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 12px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .footer { text-align: center; padding: 24px 0; border-top: 1px solid var(--border); color: var(--text-dim); font-size: 12px; }
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ë°ì¼ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
    <div class="date" id="reportDate">ë°ì´í„° ë¡œë”© ì¤‘...</div>
  </div>
  <div class="disclaimer">âš ï¸ ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡/ì°¸ê³  ëª©ì ì´ë©°<br>íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤</div>
</div>

<div class="date-nav">
  <button id="prevBtn">â—€ ì „ì¼</button>
  <input type="date" id="datePicker" />
  <button id="nextBtn">ìµì¼ â–¶</button>
  <button class="active" id="todayBtn">ì˜¤ëŠ˜</button>
  <button class="refresh-btn" id="refreshBtn">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
</div>

<div class="summary-grid" id="summaryCards"></div>

<div class="section">
  <div class="section-header">
    <h2>ì„¹í„°ë³„ ë¶„ìœ„ê¸°</h2>
    <span class="badge badge-sector">5 Sectors</span>
  </div>
  <div class="sector-grid" id="sectorGrid"></div>
</div>

<div class="section">
  <div class="section-header">
    <h2>ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì¢…ëª© í˜„í™©</h2>
    <span class="badge badge-us">US Market</span>
  </div>
  <div id="usTable"></div>
</div>

<div class="section">
  <div class="section-header">
    <h2>ğŸ‡°ğŸ‡· í•œêµ­ ì¢…ëª© í˜„í™©</h2>
    <span class="badge badge-kr">KR Market</span>
  </div>
  <div id="krTable"></div>
</div>

<div id="insightBox"></div>

<div class="footer">
  <p>ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ë°ì¼ë¦¬ ëŒ€ì‹œë³´ë“œ | Powered by Supabase & Vercel</p>
</div>

<script>
(function() {
  'use strict';

  // ===== í™˜ê²½ ë³€ìˆ˜ ë° ì„¤ì • (Vercel ì—°ë™) =====
  // Vercel Settingsì—ì„œ NEXT_PUBLIC_SUPABASE_URL ë“±ìœ¼ë¡œ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.
  var SUPABASE_URL = (typeof process !== 'undefined' && process.env.NEXT_PUBLIC_SUPABASE_URL) 
                     ? process.env.NEXT_PUBLIC_SUPABASE_URL 
                     : 'https://xqfvkhlfvctxokciuogd.supabase.co'; // ê¸°ë³¸ê°’

  var SUPABASE_KEY = (typeof process !== 'undefined' && process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) 
                     ? process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY 
                     : ''; // Vercelì—ì„œ ì£¼ì…ë°›ê±°ë‚˜ ì§ì ‘ ì…ë ¥ ê°€ëŠ¥

  var supabaseClient = null;
  var currentDate = new Date().toISOString().split('T')[0];

  // ì„¹í„° ì•„ì´ì½˜ ë° ëª…ì¹­ ë§µ
  var SECTOR_MAP = {
    'AIë°˜ë„ì²´': { icon: 'ğŸ§ ', name: 'AI ë°˜ë„ì²´' },
    'ë¡œë´‡ììœ¨ì£¼í–‰': { icon: 'ğŸ¤–', name: 'ë¡œë´‡Â·ììœ¨ì£¼í–‰' },
    'ë°”ì´ì˜¤í—¬ìŠ¤ì¼€ì–´': { icon: 'ğŸ§¬', name: 'ë°”ì´ì˜¤Â·í—¬ìŠ¤ì¼€ì–´' },
    'ìš°ì£¼ë°©ì‚°': { icon: 'ğŸ›¡ï¸', name: 'ìš°ì£¼Â·ë°©ì‚°' },
    'ì–‘ìì—ë„ˆì§€': { icon: 'âš¡', name: 'ì–‘ìÂ·ì—ë„ˆì§€' }
  };

  var SIGNAL_LABELS = {
    'positive': { label: 'ê¸ì •', cls: 'signal-positive' },
    'hold':     { label: 'ê´€ë§', cls: 'signal-hold' },
    'watch':    { label: 'ì£¼ì‹œ', cls: 'signal-watch' },
    'caution':  { label: 'ì£¼ì˜', cls: 'signal-caution' }
  };

  var $datePicker = document.getElementById('datePicker');
  var $reportDate = document.getElementById('reportDate');
  var $refreshBtn = document.getElementById('refreshBtn');

  // ===== Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” =====
  function initSupabase() {
    if (!SUPABASE_URL || !SUPABASE_KEY) return false;
    try {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      return true;
    } catch(e) {
      console.error('Supabase init error:', e);
      return false;
    }
  }

  // ===== ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ =====
  async function loadData(date) {
    if (!supabaseClient) {
      showEmptyState('ì„¤ì •ëœ Supabase ì—°ê²° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    showLoading();
    try {
      // 1. snapshots, 2. summary, 3. stocks ì •ë³´ë¥¼ ë³‘ë ¬ë¡œ ê°€ì ¸ì˜´
      var results = await Promise.all([
        supabaseClient.from('daily_snapshots').select('*').eq('report_date', date),
        supabaseClient.from('daily_summary').select('*').eq('report_date', date).single(),
        supabaseClient.from('portfolio_stocks').select('*')
      ]);

      var snapshots = results[0].data || [];
      var summary = results[1].data;
      var stocks = results[2].data || [];

      if (snapshots.length === 0) {
        $reportDate.textContent = formatDate(date) + ' â€” ë°ì´í„° ì—†ìŒ';
        showEmptyState('í•´ë‹¹ ë‚ ì§œì— ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var merged = snapshots.map(function(s) {
        var stockInfo = stocks.find(function(st) { return st.ticker === s.ticker; }) || {};
        return Object.assign({}, s, stockInfo);
      });

      var usStocks = merged.filter(function(s) { return s.market === 'US'; });
      var krStocks = merged.filter(function(s) { return s.market === 'KR'; });

      $reportDate.textContent = formatDate(date) + ' | í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬í¬íŠ¸';
      renderSummary(usStocks, krStocks, summary);
      renderSectors(merged);
      renderStockTable('usTable', usStocks, 'US');
      renderStockTable('krTable', krStocks, 'KR');
      renderInsights(summary);
    } catch (err) {
      console.error('Load error:', err);
      showEmptyState('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜: ' + err.message);
    }
  }

  // ===== [ë¦¬íŒ©í† ë§ í¬ì¸íŠ¸] ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (ì–´ë“œë¯¼ íŒ¨ìŠ¤ì›Œë“œ ì¸ì¦) =====
  async function triggerRefresh() {
    // 1. ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (0649)
    const adminPassword = prompt("ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ë ¤ë©´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
    
    if (adminPassword !== "0649") {
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë§Œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    if (!supabaseClient) { alert("ì—°ê²° ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
    
    $refreshBtn.disabled = true;
    $refreshBtn.textContent = 'â³ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...';

    try {
      // Supabase Edge Function í˜¸ì¶œ
      var result = await supabaseClient.functions.invoke('daily-report', { method: 'POST' });
      
      if (result.error) throw result.error;
      
      alert("ë°ì´í„° ìˆ˜ì§‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      $refreshBtn.textContent = 'âœ… ì™„ë£Œ';
      setTimeout(function() {
        $refreshBtn.textContent = 'ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨';
        $refreshBtn.disabled = false;
        loadData(currentDate); // ìƒˆë¡œ ìˆ˜ì§‘ëœ ë°ì´í„°ë¡œ ê°±ì‹ 
      }, 2000);
    } catch (err) {
      console.error('Refresh error:', err);
      alert("ìˆ˜ì§‘ ì‹¤íŒ¨: " + err.message);
      $refreshBtn.textContent = 'ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨';
      $refreshBtn.disabled = false;
    }
  }

  // ===== ë Œë”ë§ ë„ìš°ë¯¸ í•¨ìˆ˜ë“¤ (ìƒëµ ì—†ì´ ì›ë³¸ ìœ ì§€) =====
  function renderSummary(us, kr, summary) {
    var usUp = us.filter(function(s) { return (s.price_change_pct || 0) > 0; }).length;
    var krUp = kr.filter(function(s) { return (s.price_change_pct || 0) > 0; }).length;

    document.getElementById('summaryCards').innerHTML =
      '<div class="summary-card"><div class="label">ë¯¸êµ­ ì¢…ëª©</div><div class="value" style="color:var(--blue)">' + us.length + 'ì¢…ëª©</div><div class="sub">' + usUp + ' ìƒìŠ¹ / ' + (us.length - usUp) + ' í•˜ë½</div></div>' +
      '<div class="summary-card"><div class="label">í•œêµ­ ì¢…ëª©</div><div class="value" style="color:#f87171">' + kr.length + 'ì¢…ëª©</div><div class="sub">' + krUp + ' ìƒìŠ¹ / ' + (kr.length - krUp) + ' í•˜ë½</div></div>' +
      '<div class="summary-card"><div class="label">ì‹œì¥ ë¶„ì„</div><div class="value" style="color:var(--orange)">' + (summary ? summary.overall_signal : 'í˜¼ì¡°') + '</div><div class="sub">' + (summary ? summary.us_market_trend : '-') + '</div></div>' +
      '<div class="summary-card"><div class="label">ê¸°ì¤€ì¼</div><div class="value" style="color:var(--text)">' + currentDate + '</div></div>';
  }

  function renderSectors(stocks) {
    var html = '';
    Object.keys(SECTOR_MAP).forEach(function(sector) {
      var info = SECTOR_MAP[sector];
      var list = stocks.filter(function(s) { return s.sector === sector; });
      var avg = list.length > 0 ? list.reduce(function(sum, s) { return sum + (s.price_change_pct || 0); }, 0) / list.length : 0;
      html += '<div class="sector-card"><div class="icon">' + info.icon + '</div><div class="name">' + info.name + '</div><div class="perf">' + (avg > 0 ? '+' : '') + avg.toFixed(2) + '%</div></div>';
    });
    document.getElementById('sectorGrid').innerHTML = html;
  }

  function renderStockTable(containerId, stocks, market) {
    var rows = '';
    stocks.forEach(function(s) {
      var cls = (s.price_change_pct||0) > 0 ? 'change-pos' : (s.price_change_pct||0) < 0 ? 'change-neg' : '';
      var sig = SIGNAL_LABELS[s.signal] || SIGNAL_LABELS['hold'];
      var prc = market === 'US' ? '$' + (s.current_price||0).toLocaleString() : 'â‚©' + (s.current_price||0).toLocaleString();
      rows += '<tr><td><div class="ticker">' + s.ticker + '</div><div class="company-name">' + (s.company_name||'') + '</div></td>' +
              '<td class="price">' + prc + '</td><td class="' + cls + '">' + (s.price_change_pct||0).toFixed(2) + '%</td>' +
              '<td><span class="signal ' + sig.cls + '">' + sig.label + '</span></td><td><div class="news-item">' + (s.news_1 || s.signal_reason || '-') + '</div></td></tr>';
    });
    document.getElementById(containerId).innerHTML = '<table class="stock-table"><thead><tr><th>ì¢…ëª©</th><th>í˜„ì¬ê°€</th><th>ë³€ë™</th><th>ì‹œê·¸ë„</th><th>ë‰´ìŠ¤</th></tr></thead><tbody>' + rows + '</tbody></table>';
  }

  function renderInsights(summary) {
    if (!summary || !summary.insights) { document.getElementById('insightBox').innerHTML = ''; return; }
    var items = '';
    summary.insights.forEach(function(i) { items += '<li>' + i + '</li>'; });
    document.getElementById('insightBox').innerHTML = '<div class="insight-box"><h3>ğŸ“‹ ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸</h3><ul>' + items + '</ul></div>';
  }

  function showLoading() {
    var loader = '<div class="loading"><div class="spinner"></div>ë°ì´í„° ë¡œë“œ ì¤‘...</div>';
    document.getElementById('summaryCards').innerHTML = loader;
  }

  function showEmptyState(msg) {
    document.getElementById('summaryCards').innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim)">' + msg + '</div>';
  }

  function formatDate(dateStr) {
    var d = new Date(dateStr + 'T00:00:00');
    return d.getFullYear() + 'ë…„ ' + (d.getMonth()+1) + 'ì›” ' + d.getDate() + 'ì¼';
  }

  // ===== ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
  $datePicker.value = currentDate;
  $datePicker.addEventListener('change', function() { currentDate = this.value; loadData(currentDate); });
  document.getElementById('todayBtn').addEventListener('click', function() { currentDate = new Date().toISOString().split('T')[0]; $datePicker.value = currentDate; loadData(currentDate); });
  $refreshBtn.addEventListener('click', triggerRefresh);

  if (initSupabase()) {
    loadData(currentDate);
  } else {
    showEmptyState('ì„¤ì • ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Vercel í™˜ê²½ ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
  }

})();
</script>
</body>
</html>