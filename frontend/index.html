<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í¬íŠ¸í´ë¦¬ì˜¤ ë°ì¼ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg: #0f1117; --card: #1a1d2e; --card-hover: #222640;
    --border: #2a2d3e; --text: #e4e6f0; --text-dim: #8b8fa3;
    --accent: #6366f1; --green: #22c55e; --red: #ef4444;
    --orange: #f59e0b; --blue: #3b82f6; --purple: #a855f7; --cyan: #06b6d4;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--bg); color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6; padding: 20px; max-width: 1400px; margin: 0 auto;
  }
  .header {
    display: flex; justify-content: space-between; align-items: flex-start;
    padding: 24px 0; border-bottom: 1px solid var(--border); margin-bottom: 24px;
  }
  .header h1 { font-size: 24px; font-weight: 700; }
  .header .date { color: var(--text-dim); font-size: 14px; margin-top: 4px; }
  .disclaimer {
    background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
    color: #fca5a5; padding: 8px 16px; border-radius: 8px; font-size: 12px;
    max-width: 360px; text-align: right;
  }
  .date-nav { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
  .date-nav button {
    background: var(--card); border: 1px solid var(--border); color: var(--text);
    padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s;
  }
  .date-nav button:hover { border-color: var(--accent); background: var(--card-hover); }
  .date-nav button.active { border-color: var(--accent); background: rgba(99,102,241,0.15); }
  .date-nav input[type="date"] {
    background: var(--card); border: 1px solid var(--border); color: var(--text);
    padding: 8px 12px; border-radius: 8px; font-size: 14px;
  }
  .refresh-btn {
    background: linear-gradient(135deg, var(--accent), var(--purple));
    border: none; color: white; padding: 8px 20px; border-radius: 8px;
    cursor: pointer; font-size: 14px; font-weight: 600; transition: opacity 0.2s;
  }
  .refresh-btn:hover { opacity: 0.85; }
  .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .settings-btn {
    background: var(--card); border: 1px solid var(--border); color: var(--text-dim);
    padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; transition: all 0.2s;
  }
  .settings-btn:hover { border-color: var(--accent); color: var(--text); }
  .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .summary-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px;
  }
  .summary-card .label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
  .summary-card .value { font-size: 28px; font-weight: 700; margin-top: 4px; }
  .summary-card .sub { font-size: 13px; margin-top: 4px; }
  .section { margin-bottom: 32px; }
  .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
  .section-header h2 { font-size: 18px; font-weight: 600; }
  .badge { font-size: 11px; padding: 3px 10px; border-radius: 20px; font-weight: 500; }
  .badge-us { background: rgba(59,130,246,0.15); color: var(--blue); }
  .badge-kr { background: rgba(239,68,68,0.15); color: #f87171; }
  .badge-sector { background: rgba(168,85,247,0.15); color: var(--purple); }
  .sector-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px; }
  .sector-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 12px;
    padding: 16px; text-align: center; transition: border-color 0.2s;
  }
  .sector-card:hover { border-color: var(--accent); }
  .sector-card .icon { font-size: 24px; margin-bottom: 8px; }
  .sector-card .name { font-size: 13px; font-weight: 600; }
  .sector-card .perf { font-size: 18px; font-weight: 700; margin-top: 4px; }
  .sector-card .detail { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
  .stock-table {
    width: 100%; border-collapse: separate; border-spacing: 0;
    background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
  }
  .stock-table thead th {
    background: rgba(99,102,241,0.08); padding: 12px 16px; text-align: left;
    font-size: 12px; color: var(--text-dim); text-transform: uppercase;
    letter-spacing: 0.5px; font-weight: 600; border-bottom: 1px solid var(--border);
  }
  .stock-table tbody td {
    padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle;
  }
  .stock-table tbody tr:last-child td { border-bottom: none; }
  .stock-table tbody tr:hover { background: var(--card-hover); }
  .ticker { font-weight: 700; color: var(--accent); font-size: 15px; }
  .company-name { color: var(--text-dim); font-size: 12px; }
  .price { font-weight: 600; font-size: 15px; font-variant-numeric: tabular-nums; }
  .change-pos { color: var(--green); font-weight: 600; }
  .change-neg { color: var(--red); font-weight: 600; }
  .change-neutral { color: var(--text-dim); }
  .signal {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
  }
  .signal-positive { background: rgba(34,197,94,0.15); color: var(--green); }
  .signal-hold { background: rgba(245,158,11,0.15); color: var(--orange); }
  .signal-watch { background: rgba(99,102,241,0.15); color: var(--accent); }
  .signal-caution { background: rgba(239,68,68,0.15); color: var(--red); }
  .news-item { font-size: 12px; color: var(--text-dim); line-height: 1.5; padding: 2px 0; }
  .news-item::before { content: "â€¢"; color: var(--accent); margin-right: 6px; }
  .insight-box {
    background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(168,85,247,0.08));
    border: 1px solid rgba(99,102,241,0.2); border-radius: 12px; padding: 24px; margin-bottom: 24px;
  }
  .insight-box h3 { color: var(--accent); font-size: 16px; margin-bottom: 12px; }
  .insight-box ul { list-style: none; padding: 0; }
  .insight-box li { padding: 6px 0; font-size: 14px; border-bottom: 1px solid rgba(99,102,241,0.1); }
  .insight-box li:last-child { border-bottom: none; }
  .insight-box li::before { content: "â†’"; color: var(--accent); margin-right: 8px; }
  .loading {
    display: flex; align-items: center; justify-content: center;
    padding: 60px; color: var(--text-dim); font-size: 16px;
  }
  .loading .spinner {
    width: 24px; height: 24px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite; margin-right: 12px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== CONFIG PANEL (ìˆ˜ì •ë¨) ===== */
  .config-overlay {
    display: none;
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 999;
    justify-content: center; align-items: center;
  }
  .config-overlay.visible { display: flex; }
  .config-panel {
    background: var(--card); border: 1px solid var(--border); border-radius: 16px;
    padding: 32px; width: 480px; max-width: 90vw; position: relative;
  }
  .config-panel h3 { font-size: 18px; margin-bottom: 8px; color: var(--accent); }
  .config-panel p { font-size: 13px; color: var(--text-dim); margin-bottom: 20px; }
  .config-panel label { display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 4px; margin-top: 12px; }
  .config-panel input {
    background: var(--bg); border: 1px solid var(--border); color: var(--text);
    padding: 10px 14px; border-radius: 8px; width: 100%; font-size: 14px;
    outline: none; transition: border-color 0.2s;
  }
  .config-panel input:focus { border-color: var(--accent); }
  .config-panel input::placeholder { color: #555; }
  .config-actions { display: flex; gap: 12px; margin-top: 24px; }
  .config-actions .btn-save {
    flex: 1; background: var(--accent); border: none; color: white;
    padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;
  }
  .config-actions .btn-save:hover { opacity: 0.9; }
  .config-actions .btn-cancel {
    background: var(--bg); border: 1px solid var(--border); color: var(--text-dim);
    padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;
  }
  .config-actions .btn-cancel:hover { border-color: var(--accent); color: var(--text); }
  .config-close {
    position: absolute; top: 16px; right: 16px; background: none; border: none;
    color: var(--text-dim); font-size: 20px; cursor: pointer; padding: 4px;
  }
  .config-close:hover { color: var(--text); }
  .config-status {
    margin-top: 12px; padding: 8px 12px; border-radius: 6px; font-size: 13px; display: none;
  }
  .config-status.success { display: block; background: rgba(34,197,94,0.1); color: var(--green); }
  .config-status.error { display: block; background: rgba(239,68,68,0.1); color: var(--red); }
  .footer {
    text-align: center; padding: 24px 0; border-top: 1px solid var(--border);
    color: var(--text-dim); font-size: 12px;
  }
  @media (max-width: 768px) {
    .summary-grid { grid-template-columns: repeat(2, 1fr); }
    .sector-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<!-- CONFIG OVERLAY (ëª¨ë‹¬ ë°©ì‹ìœ¼ë¡œ ë³€ê²½) -->
<div class="config-overlay" id="configOverlay">
  <div class="config-panel">
    <button class="config-close" id="configCloseBtn">&times;</button>
    <h3>âš™ï¸ Supabase ì—°ê²° ì„¤ì •</h3>
    <p>Supabase Dashboard â†’ Settings â†’ API ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <label for="cfgUrl">Project URL</label>
    <input id="cfgUrl" type="text" placeholder="https://your-project.supabase.co" autocomplete="off" />
    <label for="cfgKey">Anon Public Key</label>
    <input id="cfgKey" type="text" placeholder="eyJhbGciOiJIUzI1NiIs..." autocomplete="off" />
    <div class="config-status" id="configStatus"></div>
    <div class="config-actions">
      <button class="btn-cancel" id="configCancelBtn">ì·¨ì†Œ</button>
      <button class="btn-save" id="configSaveBtn">ì €ì¥ í›„ ì—°ê²°</button>
    </div>
  </div>
</div>

<!-- HEADER -->
<div class="header">
  <div>
    <h1>ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ë°ì¼ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
    <div class="date" id="reportDate">ë°ì´í„° ë¡œë”© ì¤‘...</div>
  </div>
  <div class="disclaimer">âš ï¸ ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡/ì°¸ê³  ëª©ì ì´ë©°<br>íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤</div>
</div>

<!-- DATE NAVIGATION -->
<div class="date-nav">
  <button id="prevBtn">â—€ ì „ì¼</button>
  <input type="date" id="datePicker" />
  <button id="nextBtn">ìµì¼ â–¶</button>
  <button class="active" id="todayBtn">ì˜¤ëŠ˜</button>
  <button class="refresh-btn" id="refreshBtn">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
  <button class="settings-btn" id="settingsBtn">âš™ï¸ ì„¤ì •</button>
</div>

<!-- SUMMARY CARDS -->
<div class="summary-grid" id="summaryCards"></div>

<!-- SECTOR OVERVIEW -->
<div class="section">
  <div class="section-header">
    <h2>ì„¹í„°ë³„ ë¶„ìœ„ê¸°</h2>
    <span class="badge badge-sector">5 Sectors</span>
  </div>
  <div class="sector-grid" id="sectorGrid"></div>
</div>

<!-- US STOCKS -->
<div class="section">
  <div class="section-header">
    <h2>ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì¢…ëª© í˜„í™©</h2>
    <span class="badge badge-us">US Market</span>
  </div>
  <div id="usTable"></div>
</div>

<!-- KR STOCKS -->
<div class="section">
  <div class="section-header">
    <h2>ğŸ‡°ğŸ‡· í•œêµ­ ì¢…ëª© í˜„í™©</h2>
    <span class="badge badge-kr">KR Market</span>
  </div>
  <div id="krTable"></div>
</div>

<!-- INSIGHTS -->
<div id="insightBox"></div>

<!-- FOOTER -->
<div class="footer">
  <p>ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ë°ì¼ë¦¬ ëŒ€ì‹œë³´ë“œ | Powered by Supabase</p>
  <p style="margin-top:4px">âš ï¸ ë³¸ ë¦¬í¬íŠ¸ëŠ” êµìœ¡/ì°¸ê³  ëª©ì ì´ë©°, íŠ¹ì • ì¢…ëª©ì˜ ë§¤ìˆ˜Â·ë§¤ë„ë¥¼ ê¶Œìœ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
</div>

<script>
(function() {
  'use strict';

  // ===== Safe localStorage wrapper =====
  var storage = {
    get: function(key) {
      try { return localStorage.getItem(key) || ''; } catch(e) { return ''; }
    },
    set: function(key, val) {
      try { localStorage.setItem(key, val); } catch(e) { console.warn('localStorage unavailable'); }
    }
  };

  // ===== State =====
  var SUPABASE_URL = storage.get('sb_url');
  var SUPABASE_KEY = storage.get('sb_key');
  var supabaseClient = null;
  var currentDate = new Date().toISOString().split('T')[0];

  var SECTOR_MAP = {
    'AIë°˜ë„ì²´': { icon: 'ğŸ§ ', name: 'AI ë°˜ë„ì²´' },
    'ë¡œë´‡ììœ¨ì£¼í–‰': { icon: 'ğŸ¤–', name: 'ë¡œë´‡Â·ììœ¨ì£¼í–‰' },
    'ë°”ì´ì˜¤í—¬ìŠ¤ì¼€ì–´': { icon: 'ğŸ§¬', name: 'ë°”ì´ì˜¤Â·í—¬ìŠ¤ì¼€ì–´' },
    'ìš°ì£¼ë°©ì‚°': { icon: 'ğŸ›¡ï¸', name: 'ìš°ì£¼Â·ë°©ì‚°' },
    'ì–‘ìì—ë„ˆì§€': { icon: 'âš¡', name: 'ì–‘ìÂ·ì—ë„ˆì§€' }
  };

  var SIGNAL_LABELS = {
    'positive': { label: 'ê¸ì •', cls: 'signal-positive' },
    'hold':     { label: 'ê´€ë§', cls: 'signal-hold' },
    'watch':    { label: 'ì£¼ì‹œ', cls: 'signal-watch' },
    'caution':  { label: 'ì£¼ì˜', cls: 'signal-caution' }
  };

  // ===== DOM References =====
  var $overlay      = document.getElementById('configOverlay');
  var $cfgUrl       = document.getElementById('cfgUrl');
  var $cfgKey       = document.getElementById('cfgKey');
  var $cfgStatus    = document.getElementById('configStatus');
  var $datePicker   = document.getElementById('datePicker');
  var $reportDate   = document.getElementById('reportDate');
  var $refreshBtn   = document.getElementById('refreshBtn');

  // ===== Config Panel Controls =====
  function openConfig() {
    $cfgUrl.value = SUPABASE_URL;
    $cfgKey.value = SUPABASE_KEY;
    $cfgStatus.className = 'config-status';
    $cfgStatus.textContent = '';
    $overlay.classList.add('visible');
  }

  function closeConfig() {
    $overlay.classList.remove('visible');
  }

  function saveConfig() {
    var url = $cfgUrl.value.trim();
    var key = $cfgKey.value.trim();

    if (!url || !key) {
      $cfgStatus.className = 'config-status error';
      $cfgStatus.textContent = 'URLê³¼ Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      return;
    }
    if (!url.startsWith('https://') || !url.includes('.supabase.co')) {
      $cfgStatus.className = 'config-status error';
      $cfgStatus.textContent = 'URL í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (https://xxx.supabase.co)';
      return;
    }

    SUPABASE_URL = url;
    SUPABASE_KEY = key;
    storage.set('sb_url', url);
    storage.set('sb_key', key);

    $cfgStatus.className = 'config-status success';
    $cfgStatus.textContent = 'âœ… ì €ì¥ ì™„ë£Œ! ì—°ê²° ì¤‘...';

    setTimeout(function() {
      closeConfig();
      initSupabase();
      loadData(currentDate);
    }, 800);
  }

  // Event listeners for config
  document.getElementById('settingsBtn').addEventListener('click', function(e) {
    e.preventDefault();
    openConfig();
  });
  document.getElementById('configCloseBtn').addEventListener('click', closeConfig);
  document.getElementById('configCancelBtn').addEventListener('click', closeConfig);
  document.getElementById('configSaveBtn').addEventListener('click', saveConfig);

  // Close overlay when clicking outside panel
  $overlay.addEventListener('click', function(e) {
    if (e.target === $overlay) closeConfig();
  });

  // ===== Navigation =====
  function navigateDate(delta) {
    var d = new Date(currentDate);
    d.setDate(d.getDate() + delta);
    currentDate = d.toISOString().split('T')[0];
    $datePicker.value = currentDate;
    loadData(currentDate);
  }

  document.getElementById('prevBtn').addEventListener('click', function() { navigateDate(-1); });
  document.getElementById('nextBtn').addEventListener('click', function() { navigateDate(1); });
  document.getElementById('todayBtn').addEventListener('click', function() {
    currentDate = new Date().toISOString().split('T')[0];
    $datePicker.value = currentDate;
    loadData(currentDate);
  });
  $datePicker.addEventListener('change', function() {
    currentDate = this.value;
    loadData(currentDate);
  });
  $refreshBtn.addEventListener('click', triggerRefresh);

  // ===== Supabase Init =====
  function initSupabase() {
    if (!SUPABASE_URL || !SUPABASE_KEY) return false;
    try {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      return true;
    } catch(e) {
      console.error('Supabase init error:', e);
      return false;
    }
  }

  // ===== Data Loading =====
  async function loadData(date) {
    if (!supabaseClient) {
      showEmptyState('âš™ï¸ ì„¤ì • ë²„íŠ¼ì„ í´ë¦­í•´ì„œ Supabase URLê³¼ Anon Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    showLoading();
    try {
      var results = await Promise.all([
        supabaseClient.from('daily_snapshots').select('*').eq('report_date', date),
        supabaseClient.from('daily_summary').select('*').eq('report_date', date).single(),
        supabaseClient.from('portfolio_stocks').select('*')
      ]);

      var snapshots = results[0].data || [];
      var summary = results[1].data;
      var stocks = results[2].data || [];

      if (snapshots.length === 0) {
        $reportDate.textContent = formatDate(date) + ' â€” ë°ì´í„° ì—†ìŒ';
        showEmptyState('ì„ íƒí•œ ë‚ ì§œì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ”„ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•´ë³´ì„¸ìš”.');
        return;
      }

      var merged = snapshots.map(function(s) {
        var stockInfo = stocks.find(function(st) { return st.ticker === s.ticker; }) || {};
        return Object.assign({}, s, stockInfo);
      });

      var usStocks = merged.filter(function(s) { return s.market === 'US'; });
      var krStocks = merged.filter(function(s) { return s.market === 'KR'; });

      $reportDate.textContent = formatDate(date) + ' | ê³ ë°°ë‹¹ ETF + ë¯¸ë˜ ë¨¹ê±°ë¦¬ í¬íŠ¸í´ë¦¬ì˜¤';
      renderSummary(usStocks, krStocks, summary);
      renderSectors(merged, summary);
      renderStockTable('usTable', usStocks, 'US');
      renderStockTable('krTable', krStocks, 'KR');
      renderInsights(summary);
    } catch (err) {
      console.error('Load error:', err);
      $reportDate.textContent = 'ë°ì´í„° ë¡œë”© ì˜¤ë¥˜';
      showEmptyState('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ì½˜ì†”: ' + err.message + ')');
    }
  }

  // ===== Render Functions =====
  function renderSummary(us, kr, summary) {
    var signal = summary ? summary.overall_signal : '';
    var emoji = signal === 'bullish' ? 'ğŸŸ¢' : signal === 'bearish' ? 'ğŸ”´' : 'ğŸ”¶';
    var text = signal === 'bullish' ? 'ê°•ì„¸' : signal === 'bearish' ? 'ì•½ì„¸' : 'í˜¼ì¡°';
    var usUp = us.filter(function(s) { return (s.price_change_pct || 0) > 0; }).length;
    var krUp = kr.filter(function(s) { return (s.price_change_pct || 0) > 0; }).length;

    document.getElementById('summaryCards').innerHTML =
      '<div class="summary-card"><div class="label">ì´ í¬íŠ¸í´ë¦¬ì˜¤</div><div class="value" style="color:var(--text)">â‚©6,000,000</div><div class="sub" style="color:var(--text-dim)">ì´ˆê¸° íˆ¬ìê¸ˆ ê¸°ì¤€</div></div>' +
      '<div class="summary-card"><div class="label">ë¯¸êµ­ ì¢…ëª©</div><div class="value" style="color:var(--blue)">' + us.length + 'ì¢…ëª©</div><div class="sub" style="color:' + (usUp > us.length/2 ? 'var(--green)' : 'var(--red)') + '">' + (usUp > us.length/2 ? 'â–²' : 'â–¼') + ' ' + usUp + 'ì¢…ëª© ìƒìŠ¹ / ' + (us.length - usUp) + 'ì¢…ëª© í•˜ë½</div></div>' +
      '<div class="summary-card"><div class="label">í•œêµ­ ì¢…ëª©</div><div class="value" style="color:#f87171">' + kr.length + 'ì¢…ëª©</div><div class="sub" style="color:' + (krUp > kr.length/2 ? 'var(--green)' : 'var(--red)') + '">' + (krUp > kr.length/2 ? 'â–²' : 'â–¼') + ' ' + krUp + 'ì¢…ëª© ìƒìŠ¹ / ' + (kr.length - krUp) + 'ì¢…ëª© í•˜ë½</div></div>' +
      '<div class="summary-card"><div class="label">ì˜¤ëŠ˜ì˜ ì‹œê·¸ë„</div><div class="value" style="color:var(--orange)">' + emoji + ' ' + text + '</div><div class="sub" style="color:var(--text-dim)">' + (summary ? (summary.us_market_trend || '') + ' / ' + (summary.kr_market_trend || '') : '') + '</div></div>';
  }

  function renderSectors(stocks, summary) {
    var sectorData = {};
    stocks.forEach(function(s) {
      if (!sectorData[s.sector]) sectorData[s.sector] = [];
      sectorData[s.sector].push(s);
    });
    var html = '';
    Object.keys(SECTOR_MAP).forEach(function(sector) {
      var info = SECTOR_MAP[sector];
      var list = sectorData[sector] || [];
      var avg = list.length > 0 ? list.reduce(function(sum, s) { return sum + (s.price_change_pct || 0); }, 0) / list.length : 0;
      var trend = avg > 1 ? 'â–² ê°•ì„¸' : avg < -1 ? 'â–¼ ì¡°ì •' : 'â€” í˜¼ì¡°';
      var cls = avg > 1 ? 'change-pos' : avg < -1 ? 'change-neg' : 'change-neutral';
      var sorted = list.slice().sort(function(a,b) { return Math.abs(b.price_change_pct||0) - Math.abs(a.price_change_pct||0); });
      var top = sorted[0];
      var detail = top ? top.ticker + ' ' + ((top.price_change_pct||0) > 0 ? '+' : '') + (top.price_change_pct||0).toFixed(1) + '%' : '';
      html += '<div class="sector-card"><div class="icon">' + info.icon + '</div><div class="name">' + info.name + '</div><div class="perf ' + cls + '">' + trend + '</div><div class="detail">' + detail + '<br>í‰ê·  ' + (avg > 0 ? '+' : '') + avg.toFixed(2) + '%</div></div>';
    });
    document.getElementById('sectorGrid').innerHTML = html;
  }

  function renderStockTable(containerId, stocks, market) {
    if (stocks.length === 0) {
      document.getElementById(containerId).innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim)">ğŸ“­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    var rows = '';
    stocks.forEach(function(s) {
      var cls = (s.price_change_pct||0) > 0 ? 'change-pos' : (s.price_change_pct||0) < 0 ? 'change-neg' : 'change-neutral';
      var sym = (s.price_change_pct||0) > 0 ? '+' : '';
      var sig = SIGNAL_LABELS[s.signal] || SIGNAL_LABELS['hold'];
      var prc = market === 'US'
        ? '$' + (s.current_price||0).toLocaleString('en-US', {minimumFractionDigits:2})
        : 'â‚©' + (s.current_price||0).toLocaleString('ko-KR');
      var range = s.week52_high && s.week52_low
        ? Math.min(100, Math.max(0, ((s.current_price - s.week52_low) / (s.week52_high - s.week52_low)) * 100)) : 50;
      var rangeColor = range > 60 ? 'var(--green)' : range < 30 ? 'var(--red)' : 'var(--orange)';
      var lo = s.week52_low ? (market === 'US' ? '$' : 'â‚©') + s.week52_low.toLocaleString() : 'â€”';
      var hi = s.week52_high ? (market === 'US' ? '$' : 'â‚©') + s.week52_high.toLocaleString() : 'â€”';
      var sectorName = SECTOR_MAP[s.sector] ? SECTOR_MAP[s.sector].name : s.sector;
      rows += '<tr><td><div class="ticker">' + s.ticker + '</div><div class="company-name">' + (s.company_name||'') + ' | ' + sectorName + '</div></td>';
      rows += '<td class="price">' + prc + '</td>';
      rows += '<td class="' + cls + '">' + sym + (s.price_change_pct||0).toFixed(2) + '%</td>';
      rows += '<td><div style="position:relative;height:6px;background:var(--border);border-radius:3px;min-width:80px"><div style="position:absolute;height:100%;border-radius:3px;width:' + range + '%;background:' + rangeColor + '"></div></div><div style="font-size:11px;color:var(--text-dim);margin-top:3px">' + lo + ' â€” ' + hi + '</div></td>';
      rows += '<td><span class="signal ' + sig.cls + '">' + sig.label + '</span></td>';
      rows += '<td>';
      if (s.news_1) rows += '<div class="news-item">' + s.news_1 + '</div>';
      if (s.news_2) rows += '<div class="news-item">' + s.news_2 + '</div>';
      if (!s.news_1 && !s.news_2) rows += '<div class="news-item">' + (s.signal_reason || 'â€”') + '</div>';
      rows += '</td></tr>';
    });
    document.getElementById(containerId).innerHTML =
      '<table class="stock-table"><thead><tr><th>ì¢…ëª©</th><th>í˜„ì¬ê°€</th><th>ë³€ë™</th><th>52ì£¼ ë²”ìœ„</th><th>ì‹œê·¸ë„</th><th>ë‰´ìŠ¤/ë©”ëª¨</th></tr></thead><tbody>' + rows + '</tbody></table>';
  }

  function renderInsights(summary) {
    if (!summary || !summary.insights) { document.getElementById('insightBox').innerHTML = ''; return; }
    var ins = summary.insights;
    var items = '';
    if (Array.isArray(ins)) {
      ins.forEach(function(i) { items += '<li>' + i + '</li>'; });
    } else {
      if (ins.top_gainers) ins.top_gainers.forEach(function(g) { items += '<li><strong>' + g.ticker + '</strong> ' + (g.change > 0 ? '+' : '') + g.change.toFixed(2) + '% â€” ìƒìŠ¹ ëª¨ë©˜í…€</li>'; });
      if (ins.top_losers) ins.top_losers.forEach(function(l) { items += '<li><strong>' + l.ticker + '</strong> ' + l.change.toFixed(2) + '% â€” í•˜ë½ ì£¼ì˜</li>'; });
      if (ins.sector_leaders) items += '<li>ì„¹í„° ë¦¬ë”: ' + ins.sector_leaders + '</li>';
      if (ins.sector_laggards) items += '<li>ì„¹í„° ë¶€ì§„: ' + ins.sector_laggards + '</li>';
    }
    var action = summary.action_guide ? (typeof summary.action_guide === 'string' ? summary.action_guide : JSON.stringify(summary.action_guide)) : '';
    document.getElementById('insightBox').innerHTML =
      '<div class="insight-box"><h3>ğŸ“‹ ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸</h3><ul>' + items + '</ul>' +
      (action ? '<div style="margin-top:16px;padding-top:12px;border-top:1px solid rgba(99,102,241,0.2);font-size:13px;color:var(--text-dim)">ğŸ’¡ ' + action + '</div>' : '') +
      '</div>';
  }

  function showEmptyState(msg) {
    document.getElementById('summaryCards').innerHTML =
      '<div class="summary-card" style="grid-column:span 4;text-align:center;padding:40px">' +
      '<div style="font-size:48px;margin-bottom:16px">ğŸ“­</div>' +
      '<div style="font-size:16px;color:var(--text-dim)">' + msg + '</div></div>';
    document.getElementById('sectorGrid').innerHTML = '';
    document.getElementById('usTable').innerHTML = '';
    document.getElementById('krTable').innerHTML = '';
    document.getElementById('insightBox').innerHTML = '';
  }

  function showLoading() {
    var loader = '<div class="loading"><div class="spinner"></div>ë¡œë”© ì¤‘...</div>';
    document.getElementById('summaryCards').innerHTML = loader;
    document.getElementById('sectorGrid').innerHTML = loader;
    document.getElementById('usTable').innerHTML = loader;
    document.getElementById('krTable').innerHTML = loader;
  }

  // ===== Trigger Edge Function =====
  async function triggerRefresh() {
    if (!supabaseClient) { openConfig(); return; }
    $refreshBtn.disabled = true;
    $refreshBtn.textContent = 'â³ ìˆ˜ì§‘ ì¤‘...';
    try {
      var result = await supabaseClient.functions.invoke('daily-report', { method: 'POST' });
      if (result.error) throw result.error;
      $refreshBtn.textContent = 'âœ… ì™„ë£Œ!';
      setTimeout(function() {
        $refreshBtn.textContent = 'ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨';
        $refreshBtn.disabled = false;
        loadData(currentDate);
      }, 2000);
    } catch (err) {
      console.error('Refresh error:', err);
      $refreshBtn.textContent = 'âŒ ì‹¤íŒ¨ (ì¬ì‹œë„)';
      setTimeout(function() { $refreshBtn.textContent = 'ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨'; $refreshBtn.disabled = false; }, 3000);
    }
  }

  // ===== Helpers =====
  function formatDate(dateStr) {
    var d = new Date(dateStr + 'T00:00:00');
    var days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    return d.getFullYear() + 'ë…„ ' + (d.getMonth()+1) + 'ì›” ' + d.getDate() + 'ì¼ (' + days[d.getDay()] + ')';
  }

  // ===== Init =====
  function init() {
    $datePicker.value = currentDate;
    if (!SUPABASE_URL || !SUPABASE_KEY) {
      showEmptyState('âš™ï¸ ì„¤ì • ë²„íŠ¼ì„ í´ë¦­í•´ì„œ Supabase URLê³¼ Anon Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      openConfig();
      return;
    }
    if (initSupabase()) {
      loadData(currentDate);
    } else {
      showEmptyState('Supabase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    }
  }

  // Start when DOM is fully ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>

</body>
</html>
