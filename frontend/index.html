<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Finance Report</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg: #0f1117; --card: #1a1d2e; --card-hover: #222640;
    --border: #2a2d3e; --text: #e4e6f0; --text-dim: #8b8fa3;
    --accent: #6366f1; --green: #22c55e; --red: #ef4444;
    --orange: #f59e0b; --blue: #3b82f6; --purple: #a855f7; --cyan: #06b6d4;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--bg); color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6; padding: 20px; max-width: 1400px; margin: 0 auto;
  }
  .header { display: flex; justify-content: space-between; align-items: flex-start; padding: 24px 0; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
  .header h1 { font-size: 24px; font-weight: 700; }
  .header .date { color: var(--text-dim); font-size: 14px; margin-top: 4px; }
  .date-nav { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
  .date-nav button { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
  .date-nav button:hover { border-color: var(--accent); background: var(--card-hover); }
  .date-nav button.active { border-color: var(--accent); background: rgba(99,102,241,0.15); }
  .date-nav button:disabled { opacity: 0.4; cursor: not-allowed; border-color: var(--border); background: var(--card); }
  
  /* ë‚ ì§œ ì„ íƒê¸° ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
  .date-picker-wrapper { position: relative; }
  .date-picker-wrapper input[type="date"] { 
    background: var(--card); border: 1px solid var(--border); color: var(--text); 
    padding: 8px 12px; border-radius: 8px; font-size: 14px; cursor: pointer;
    min-width: 150px;
  }
  .date-picker-wrapper input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(0.8); cursor: pointer;
  }
  
  .refresh-btn { background: linear-gradient(135deg, var(--accent), var(--purple)); border: none; color: white; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: opacity 0.2s; }
  .refresh-btn:hover { opacity: 0.85; }
  .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .summary-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
  .summary-card .label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
  .summary-card .value { font-size: 28px; font-weight: 700; margin-top: 4px; }
  .summary-card .sub { font-size: 13px; margin-top: 4px; }
  .section { margin-bottom: 32px; }
  .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
  .section-header h2 { font-size: 18px; font-weight: 600; }
  .badge { font-size: 11px; padding: 3px 10px; border-radius: 20px; font-weight: 500; }
  .badge-us { background: rgba(59,130,246,0.15); color: var(--blue); }
  .badge-kr { background: rgba(239,68,68,0.15); color: #f87171; }
  .badge-sector { background: rgba(168,85,247,0.15); color: var(--purple); }
  .sector-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px; }
  
  /* ì„¹í„° ì¹´ë“œ + íˆ´íŒ */
  .sector-card { 
    background: var(--card); border: 1px solid var(--border); border-radius: 12px; 
    padding: 16px; text-align: center; transition: all 0.2s; 
    position: relative; cursor: pointer;
  }
  .sector-card:hover { border-color: var(--accent); background: var(--card-hover); }
  .sector-card .icon { font-size: 24px; margin-bottom: 8px; }
  .sector-card .name { font-size: 13px; font-weight: 600; }
  .sector-card .status { font-size: 16px; font-weight: 700; margin-top: 8px; padding: 4px 12px; border-radius: 20px; display: inline-block; }
  .sector-card .status.bullish { background: rgba(34,197,94,0.15); color: var(--green); }
  .sector-card .status.bearish { background: rgba(239,68,68,0.15); color: var(--red); }
  .sector-card .status.mixed { background: rgba(245,158,11,0.15); color: var(--orange); }
  
  /* ì„¹í„° íˆ´íŒ */
  .sector-tooltip {
    position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
    background: var(--card-hover); border: 1px solid var(--border); border-radius: 8px;
    padding: 12px; min-width: 180px; z-index: 100;
    opacity: 0; visibility: hidden; transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3); margin-bottom: 8px;
  }
  .sector-tooltip::after {
    content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
    border: 6px solid transparent; border-top-color: var(--border);
  }
  .sector-card:hover .sector-tooltip { opacity: 1; visibility: visible; }
  .sector-tooltip .tooltip-title { font-size: 11px; color: var(--text-dim); margin-bottom: 8px; text-transform: uppercase; }
  .sector-tooltip .ticker-list { display: flex; flex-wrap: wrap; gap: 6px; }
  .sector-tooltip .ticker-item { 
    background: rgba(99,102,241,0.15); color: var(--accent); 
    padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
  }
  
  .stock-table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .stock-table thead th { background: rgba(99,102,241,0.08); padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; border-bottom: 1px solid var(--border); }
  .stock-table tbody td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
  .stock-table tbody tr { transition: background 0.2s; position: relative; }
  .stock-table tbody tr:hover { background: var(--card-hover); }
  .ticker { font-weight: 700; color: var(--accent); font-size: 15px; }
  .company-name { color: var(--text-dim); font-size: 12px; }
  .sector-cell { font-size: 12px; color: var(--text-dim); white-space: nowrap; }
  .price { font-weight: 600; font-size: 15px; font-variant-numeric: tabular-nums; }
  .change-pos { color: var(--green); font-weight: 600; }
  .change-neg { color: var(--red); font-weight: 600; }
  .signal { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
  .signal-positive { background: rgba(34,197,94,0.15); color: var(--green); }
  .signal-hold { background: rgba(245,158,11,0.15); color: var(--orange); }
  .signal-watch { background: rgba(99,102,241,0.15); color: var(--accent); }
  .signal-caution { background: rgba(239,68,68,0.15); color: var(--red); }
  
  /* ë‰´ìŠ¤ ì…€ + ìƒì„¸ íˆ´íŒ */
  .news-cell { position: relative; }
  .news-item { font-size: 12px; color: var(--text-dim); line-height: 1.5; padding: 2px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
  .news-item::before { content: "â€¢"; color: var(--accent); margin-right: 6px; }
  
  .news-tooltip {
    position: absolute; bottom: 100%; right: 0;
    background: var(--card-hover); border: 1px solid var(--border); border-radius: 8px;
    padding: 16px; min-width: 300px; max-width: 400px; z-index: 100;
    opacity: 0; visibility: hidden; transition: all 0.2s;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4); margin-bottom: 8px;
  }
  .news-cell:hover .news-tooltip { opacity: 1; visibility: visible; }
  .news-tooltip .tooltip-header { font-size: 13px; font-weight: 600; color: var(--accent); margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
  .news-tooltip .news-detail { font-size: 13px; color: var(--text); line-height: 1.6; margin-bottom: 8px; }
  .news-tooltip .news-detail:last-child { margin-bottom: 0; }
  .news-tooltip .news-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; }
  
  .insight-box { background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(168,85,247,0.08)); border: 1px solid rgba(99,102,241,0.2); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
  .insight-box h3 { color: var(--accent); font-size: 16px; margin-bottom: 12px; }
  .insight-box ul { list-style: none; padding: 0; }
  .insight-box li { padding: 6px 0; font-size: 14px; border-bottom: 1px solid rgba(99,102,241,0.1); }
  .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: var(--text-dim); font-size: 16px; }
  .loading .spinner { width: 24px; height: 24px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 12px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .footer { text-align: center; padding: 24px 0; border-top: 1px solid var(--border); color: var(--text-dim); font-size: 12px; }
  
  /* ë°˜ì‘í˜• */
  @media (max-width: 768px) {
    .summary-grid { grid-template-columns: repeat(2, 1fr); }
    .sector-grid { grid-template-columns: repeat(2, 1fr); }
    .sector-tooltip, .news-tooltip { min-width: 200px; }
  }
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>ğŸ“Š Daily Finance Report</h1>
    <div class="date" id="reportDate">ë°ì´í„° ë¡œë”© ì¤‘...</div>
  </div>
</div>

<div class="date-nav">
  <button id="prevBtn">â—€ ì „ì¼</button>
  <div class="date-picker-wrapper">
    <input type="date" id="datePicker" />
  </div>
  <button id="nextBtn">ìµì¼ â–¶</button>
  <button class="active" id="todayBtn">ì˜¤ëŠ˜</button>
  <button class="refresh-btn" id="refreshBtn">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
</div>

<div class="summary-grid" id="summaryCards"></div>

<div class="section">
  <div class="section-header">
    <h2>ì„¹í„°ë³„ ë¶„ìœ„ê¸°</h2>
    <span class="badge badge-sector">5 Sectors</span>
  </div>
  <div class="sector-grid" id="sectorGrid"></div>
</div>

<div class="section">
  <div class="section-header">
    <h2>ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì¢…ëª© í˜„í™©</h2>
    <span class="badge badge-us">US Market</span>
  </div>
  <div id="usTable"></div>
</div>

<div class="section">
  <div class="section-header">
    <h2>ğŸ‡°ğŸ‡· í•œêµ­ ì¢…ëª© í˜„í™©</h2>
    <span class="badge badge-kr">KR Market</span>
  </div>
  <div id="krTable"></div>
</div>

<div id="insightBox"></div>

<div class="footer">
  <p>ğŸ“Š Daily Finance Report | Powered by Supabase & Vercel</p>
</div>

<script>
(function() {
  'use strict';

  // ===== Supabase ì§ì ‘ ì—°ê²° ì„¤ì • =====
  var SUPABASE_URL = 'https://xqfvkhlfvctxokciuogd.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxZnZraGxmdmN0eG9rY2l1b2dkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDc2ODQsImV4cCI6MjA4NjM4MzY4NH0.eKXB5YvFW09ic5M5afjPFgF58OoCuG0N-38YFNl7qp8';

  var supabaseClient = null;
  var currentDate = new Date().toISOString().split('T')[0];
  var allStocksData = []; // ì „ì²´ ì¢…ëª© ë°ì´í„° ìºì‹œ

  // ì„¹í„° ì•„ì´ì½˜ ë° ëª…ì¹­ ë§µ
  var SECTOR_MAP = {
    'AIë°˜ë„ì²´': { icon: 'ğŸ§ ', name: 'AI ë°˜ë„ì²´' },
    'ë¡œë´‡ììœ¨ì£¼í–‰': { icon: 'ğŸ¤–', name: 'ë¡œë´‡Â·ììœ¨ì£¼í–‰' },
    'ë°”ì´ì˜¤í—¬ìŠ¤ì¼€ì–´': { icon: 'ğŸ§¬', name: 'ë°”ì´ì˜¤Â·í—¬ìŠ¤ì¼€ì–´' },
    'ìš°ì£¼ë°©ì‚°': { icon: 'ğŸ›¡ï¸', name: 'ìš°ì£¼Â·ë°©ì‚°' },
    'ì–‘ìì—ë„ˆì§€': { icon: 'âš¡', name: 'ì–‘ìÂ·ì—ë„ˆì§€' }
  };

  var SIGNAL_LABELS = {
    'positive': { label: 'ê¸ì •', cls: 'signal-positive' },
    'hold':     { label: 'ê´€ë§', cls: 'signal-hold' },
    'watch':    { label: 'ì£¼ì‹œ', cls: 'signal-watch' },
    'caution':  { label: 'ì£¼ì˜', cls: 'signal-caution' }
  };

  var $datePicker = document.getElementById('datePicker');
  var $reportDate = document.getElementById('reportDate');
  var $refreshBtn = document.getElementById('refreshBtn');
  var $prevBtn = document.getElementById('prevBtn');
  var $nextBtn = document.getElementById('nextBtn');
  var $todayBtn = document.getElementById('todayBtn');

  // ===== Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” =====
  function initSupabase() {
    if (!SUPABASE_URL || !SUPABASE_KEY) return false;
    try {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      return true;
    } catch(e) {
      console.error('Supabase init error:', e);
      return false;
    }
  }

  // ===== ë‚ ì§œ ë³€ê²½ í•¨ìˆ˜ =====
  function changeDate(offset) {
    console.log('changeDate called with offset:', offset, 'currentDate before:', currentDate);
    var d = new Date(currentDate);
    d.setDate(d.getDate() + offset);
    var newDate = d.getFullYear() + '-' + 
      String(d.getMonth() + 1).padStart(2, '0') + '-' + 
      String(d.getDate()).padStart(2, '0');
    currentDate = newDate;
    $datePicker.value = currentDate;
    console.log('currentDate after:', currentDate);
    updateTodayButton();
    loadData(currentDate);
  }

  function updateTodayButton() {
    var today = new Date().toISOString().split('T')[0];
    if (currentDate === today) {
      $todayBtn.classList.add('active');
      $nextBtn.disabled = true; // ì˜¤ëŠ˜ì´ë©´ ìµì¼ ë²„íŠ¼ ë¹„í™œì„±í™”
    } else {
      $todayBtn.classList.remove('active');
      $nextBtn.disabled = currentDate >= today; // ì˜¤ëŠ˜ ì´í›„ë©´ ë¹„í™œì„±í™”
    }
  }

  // ===== ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ =====
  async function loadData(date) {
    if (!supabaseClient) {
      showEmptyState('ì„¤ì •ëœ Supabase ì—°ê²° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    showLoading();
    try {
      var results = await Promise.all([
        supabaseClient.from('daily_snapshots').select('*').eq('report_date', date),
        supabaseClient.from('daily_summary').select('*').eq('report_date', date).single(),
        supabaseClient.from('portfolio_stocks').select('*')
      ]);

      var snapshots = results[0].data || [];
      var summary = results[1].data;
      var stocks = results[2].data || [];

      if (snapshots.length === 0) {
        $reportDate.textContent = formatDate(date) + ' â€” ë°ì´í„° ì—†ìŒ';
        showEmptyState('í•´ë‹¹ ë‚ ì§œì— ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var merged = snapshots.map(function(s) {
        var stockInfo = stocks.find(function(st) { return st.ticker === s.ticker; }) || {};
        return Object.assign({}, s, stockInfo);
      });

      allStocksData = merged; // ìºì‹œ ì €ì¥

      var usStocks = merged.filter(function(s) { return s.market === 'US'; });
      var krStocks = merged.filter(function(s) { return s.market === 'KR'; });

      $reportDate.textContent = formatDate(date) + ' | Finance Report';
      renderSummary(usStocks, krStocks, summary);
      renderSectors(merged);
      renderStockTable('usTable', usStocks, 'US');
      renderStockTable('krTable', krStocks, 'KR');
      renderInsights(summary);
    } catch (err) {
      console.error('Load error:', err);
      showEmptyState('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜: ' + err.message);
    }
  }

  // ===== ë°ì´í„° ìƒˆë¡œê³ ì¹¨ =====
  async function triggerRefresh() {
    var adminPassword = prompt("ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ë ¤ë©´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
    
    if (adminPassword !== "0649") {
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë§Œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    if (!supabaseClient) { alert("ì—°ê²° ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
    
    $refreshBtn.disabled = true;
    $refreshBtn.textContent = 'â³ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...';

    try {
      var result = await supabaseClient.functions.invoke('daily-report', { method: 'POST' });
      
      if (result.error) throw result.error;
      
      alert("ë°ì´í„° ìˆ˜ì§‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      $refreshBtn.textContent = 'âœ… ì™„ë£Œ';
      setTimeout(function() {
        $refreshBtn.textContent = 'ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨';
        $refreshBtn.disabled = false;
        loadData(currentDate);
      }, 2000);
    } catch (err) {
      console.error('Refresh error:', err);
      alert("ìˆ˜ì§‘ ì‹¤íŒ¨: " + err.message);
      $refreshBtn.textContent = 'ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨';
      $refreshBtn.disabled = false;
    }
  }

  // ===== ì„¹í„° ìƒíƒœ íŒì • (ê°•ì„¸/í˜¼ì¡°/ì¡°ì •) =====
  function getSectorStatus(avgPct) {
    if (avgPct > 1) return { label: 'ê°•ì„¸', cls: 'bullish', icon: 'â–²' };
    if (avgPct < -1) return { label: 'ì¡°ì •', cls: 'bearish', icon: 'â–¼' };
    return { label: 'í˜¼ì¡°', cls: 'mixed', icon: 'â€”' };
  }

  // ===== ë Œë”ë§ í•¨ìˆ˜ë“¤ =====
  function renderSummary(us, kr, summary) {
    var usUp = us.filter(function(s) { return (s.price_change_pct || 0) > 0; }).length;
    var krUp = kr.filter(function(s) { return (s.price_change_pct || 0) > 0; }).length;

    document.getElementById('summaryCards').innerHTML =
      '<div class="summary-card"><div class="label">ë¯¸êµ­ ì¢…ëª©</div><div class="value" style="color:var(--blue)">' + us.length + 'ì¢…ëª©</div><div class="sub">' + usUp + ' ìƒìŠ¹ / ' + (us.length - usUp) + ' í•˜ë½</div></div>' +
      '<div class="summary-card"><div class="label">í•œêµ­ ì¢…ëª©</div><div class="value" style="color:#f87171">' + kr.length + 'ì¢…ëª©</div><div class="sub">' + krUp + ' ìƒìŠ¹ / ' + (kr.length - krUp) + ' í•˜ë½</div></div>' +
      '<div class="summary-card"><div class="label">ì‹œì¥ ë¶„ì„</div><div class="value" style="color:var(--orange)">' + (summary ? summary.overall_signal : 'í˜¼ì¡°') + '</div><div class="sub">' + (summary ? summary.us_market_trend : '-') + '</div></div>' +
      '<div class="summary-card"><div class="label">ê¸°ì¤€ì¼</div><div class="value" style="color:var(--text)">' + currentDate + '</div></div>';
  }

  function renderSectors(stocks) {
    var html = '';
    Object.keys(SECTOR_MAP).forEach(function(sector) {
      var info = SECTOR_MAP[sector];
      var list = stocks.filter(function(s) { return s.sector === sector; });
      var avg = list.length > 0 ? list.reduce(function(sum, s) { return sum + (s.price_change_pct || 0); }, 0) / list.length : 0;
      var status = getSectorStatus(avg);
      
      // íˆ´íŒìš© í‹°ì»¤ ë¦¬ìŠ¤íŠ¸ ìƒì„±
      var tickerItems = list.map(function(s) {
        var changeCls = (s.price_change_pct || 0) > 0 ? 'color:var(--green)' : (s.price_change_pct || 0) < 0 ? 'color:var(--red)' : '';
        return '<span class="ticker-item">' + s.ticker + ' <span style="' + changeCls + '">' + ((s.price_change_pct || 0) > 0 ? '+' : '') + (s.price_change_pct || 0).toFixed(1) + '%</span></span>';
      }).join('');
      
      html += '<div class="sector-card">' +
        '<div class="sector-tooltip">' +
          '<div class="tooltip-title">í¬í•¨ ì¢…ëª©</div>' +
          '<div class="ticker-list">' + tickerItems + '</div>' +
        '</div>' +
        '<div class="icon">' + info.icon + '</div>' +
        '<div class="name">' + info.name + '</div>' +
        '<div class="status ' + status.cls + '">' + status.icon + ' ' + status.label + '</div>' +
      '</div>';
    });
    document.getElementById('sectorGrid').innerHTML = html;
  }

  function renderStockTable(containerId, stocks, market) {
    var rows = '';
    stocks.forEach(function(s) {
      var cls = (s.price_change_pct||0) > 0 ? 'change-pos' : (s.price_change_pct||0) < 0 ? 'change-neg' : '';
      var sig = SIGNAL_LABELS[s.signal] || SIGNAL_LABELS['hold'];
      var prc = market === 'US' ? '$' + (s.current_price||0).toLocaleString() : 'â‚©' + (s.current_price||0).toLocaleString();
      
      // ì„¹í„° ì •ë³´
      var sectorInfo = SECTOR_MAP[s.sector] || { icon: 'ğŸ“Š', name: s.sector || '-' };
      
      // ë‰´ìŠ¤ íˆ´íŒ ìƒì„±
      var news1 = s.news_1 || s.signal_reason || 'ì •ë³´ ì—†ìŒ';
      var news2 = s.news_2 || '';
      var tooltipContent = '<div class="tooltip-header">' + s.ticker + ' - ' + (s.company_name || '') + '</div>' +
        '<div class="news-label">ì‹œê·¸ë„ ê·¼ê±°</div>' +
        '<div class="news-detail">' + news1 + '</div>';
      if (news2) {
        tooltipContent += '<div class="news-label" style="margin-top:8px">ì¶”ê°€ ì •ë³´</div>' +
          '<div class="news-detail">' + news2 + '</div>';
      }
      // 52ì£¼ ë²”ìœ„ ì •ë³´ ì¶”ê°€
      if (s.week52_high && s.week52_low) {
        var currencySymbol = market === 'US' ? '$' : 'â‚©';
        tooltipContent += '<div class="news-label" style="margin-top:8px">52ì£¼ ë²”ìœ„</div>' +
          '<div class="news-detail">' + currencySymbol + (s.week52_low||0).toLocaleString() + ' ~ ' + currencySymbol + (s.week52_high||0).toLocaleString() + '</div>';
      }
      
      rows += '<tr>' +
        '<td><div class="ticker">' + s.ticker + '</div><div class="company-name">' + (s.company_name||'') + '</div></td>' +
        '<td class="sector-cell">' + sectorInfo.icon + ' ' + sectorInfo.name + '</td>' +
        '<td class="price">' + prc + '</td>' +
        '<td class="' + cls + '">' + ((s.price_change_pct||0) > 0 ? '+' : '') + (s.price_change_pct||0).toFixed(2) + '%</td>' +
        '<td><span class="signal ' + sig.cls + '">' + sig.label + '</span></td>' +
        '<td class="news-cell">' +
          '<div class="news-tooltip">' + tooltipContent + '</div>' +
          '<div class="news-item">' + news1 + '</div>' +
        '</td>' +
      '</tr>';
    });
    document.getElementById(containerId).innerHTML = '<table class="stock-table"><thead><tr><th>ì¢…ëª©</th><th>ì„¹í„°</th><th>í˜„ì¬ê°€</th><th>ë³€ë™</th><th>ì‹œê·¸ë„</th><th>ë‰´ìŠ¤</th></tr></thead><tbody>' + rows + '</tbody></table>';
  }

  function renderInsights(summary) {
    if (!summary || !summary.insights) { document.getElementById('insightBox').innerHTML = ''; return; }
    var items = '';
    if (Array.isArray(summary.insights)) {
      summary.insights.forEach(function(i) { items += '<li>' + i + '</li>'; });
    } else if (typeof summary.insights === 'object') {
      // insightsê°€ ê°ì²´ì¸ ê²½ìš° ì²˜ë¦¬
      if (summary.insights.top_gainers) {
        items += '<li>ğŸš€ ìƒìŠ¹ ì¢…ëª©: ' + summary.insights.top_gainers.map(function(g) { return g.ticker + '(' + (g.change > 0 ? '+' : '') + g.change + '%)'; }).join(', ') + '</li>';
      }
      if (summary.insights.top_losers) {
        items += '<li>ğŸ“‰ í•˜ë½ ì¢…ëª©: ' + summary.insights.top_losers.map(function(l) { return l.ticker + '(' + l.change + '%)'; }).join(', ') + '</li>';
      }
      if (summary.insights.sector_leaders) {
        items += '<li>ğŸ† ì„ ë„ ì„¹í„°: ' + summary.insights.sector_leaders + '</li>';
      }
      if (summary.insights.sector_laggards) {
        items += '<li>âš ï¸ ë¶€ì§„ ì„¹í„°: ' + summary.insights.sector_laggards + '</li>';
      }
    }
    if (items) {
      document.getElementById('insightBox').innerHTML = '<div class="insight-box"><h3>ğŸ“‹ ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸</h3><ul>' + items + '</ul></div>';
    }
  }

  function showLoading() {
    var loader = '<div class="loading"><div class="spinner"></div>ë°ì´í„° ë¡œë“œ ì¤‘...</div>';
    document.getElementById('summaryCards').innerHTML = loader;
  }

  function showEmptyState(msg) {
    document.getElementById('summaryCards').innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim)">' + msg + '</div>';
  }

  function formatDate(dateStr) {
    var d = new Date(dateStr + 'T00:00:00');
    return d.getFullYear() + 'ë…„ ' + (d.getMonth()+1) + 'ì›” ' + d.getDate() + 'ì¼';
  }

  // ===== ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
  $datePicker.value = currentDate;
  $datePicker.max = new Date().toISOString().split('T')[0]; // ì˜¤ëŠ˜ ì´í›„ ë‚ ì§œ ì„ íƒ ë¶ˆê°€
  
  // ì „ì¼/ìµì¼ ë²„íŠ¼ ì´ë²¤íŠ¸
  $prevBtn.onclick = function(e) { 
    e.preventDefault(); 
    e.stopPropagation();
    changeDate(-1); 
  };
  $nextBtn.onclick = function(e) { 
    e.preventDefault(); 
    e.stopPropagation();
    var today = new Date().toISOString().split('T')[0];
    if (currentDate >= today) {
      return; // ì˜¤ëŠ˜ ì´í›„ë¡œëŠ” ì´ë™ ë¶ˆê°€
    }
    changeDate(1); 
  };
  
  // ë‚ ì§œ ì„ íƒê¸° ë³€ê²½ ì´ë²¤íŠ¸
  $datePicker.addEventListener('change', function() { 
    currentDate = this.value; 
    updateTodayButton();
    loadData(currentDate); 
  });
  
  // ë‚ ì§œ ì„ íƒê¸° í´ë¦­ ì‹œ ìº˜ë¦°ë” ì—´ê¸°
  $datePicker.addEventListener('click', function() {
    this.showPicker && this.showPicker();
  });
  
  // ì˜¤ëŠ˜ ë²„íŠ¼
  $todayBtn.addEventListener('click', function() { 
    currentDate = new Date().toISOString().split('T')[0]; 
    $datePicker.value = currentDate; 
    updateTodayButton();
    loadData(currentDate); 
  });
  
  // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
  $refreshBtn.addEventListener('click', triggerRefresh);

  // ì´ˆê¸°í™”
  if (initSupabase()) {
    loadData(currentDate);
  } else {
    showEmptyState('ì„¤ì • ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Vercel í™˜ê²½ ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
  }

})();
</script>
</body>
</html>
